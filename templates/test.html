{% extends "base.html" %}

{% block title %}Test API{% endblock %}

{% block content %}
<div x-data="testInterface()" class="max-w-4xl mx-auto">
    <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Test InstaClaw API</h2>
        
        <!-- API Configuration -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                <input type="text" x-model="apiKey" 
                       class="w-full p-2 border border-gray-300 rounded-md"
                       placeholder="demo_a665a45920422f9d">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Optimization Preference</label>
                <select x-model="preference" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="cost">Cost (Cheapest model)</option>
                    <option value="performance">Performance (Best model)</option>
                </select>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="border border-gray-300 rounded-lg h-64 overflow-y-auto mb-4 p-4 bg-gray-50" id="chatHistory">
            <template x-for="message in chatHistory" :key="message.id">
                <div class="mb-4">
                    <div class="flex items-start space-x-2">
                        <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium" x-text="message.sender"></div>
                        <div class="text-xs text-gray-500" x-text="message.timestamp"></div>
                    </div>
                    <div class="mt-1 p-3 rounded-lg" :class="message.sender === 'You' ? 'bg-blue-50 ml-8' : 'bg-white'">
                        <div x-text="message.content"></div>
                        <div x-show="message.metadata" class="mt-2 text-xs text-gray-500">
                            <span x-text="message.metadata"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Input Area -->
        <div class="flex space-x-2">
            <input type="text" x-model="currentMessage" 
                   @keyup.enter="sendMessage()"
                   class="flex-1 p-2 border border-gray-300 rounded-md"
                   placeholder="Type your message...">
            <button @click="sendMessage()" 
                    :disabled="loading || !currentMessage.trim()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50">
                <span x-show="!loading">Send</span>
                <span x-show="loading">Sending...</span>
            </button>
        </div>
        
        <!-- Usage Stats -->
        <div x-show="lastResponse" class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold text-gray-800 mb-2">Last Response Stats</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-gray-600">Model:</span>
                    <span x-text="lastResponse.model_used" class="font-mono"></span>
                </div>
                <div>
                    <span class="text-gray-600">Tokens:</span>
                    <span x-text="lastResponse.tokens_used"></span>
                </div>
                <div>
                    <span class="text-gray-600">Cost:</span>
                    <span x-text="`$${lastResponse.cost}`"></span>
                </div>
                <div>
                    <span class="text-gray-600">Remaining:</span>
                    <span x-text="lastResponse.remaining_quota"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Documentation -->
    <div class="bg-white p-6 rounded-lg shadow mt-8">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">API Documentation</h3>
        <div class="space-y-4">
            <div>
                <h4 class="font-semibold text-gray-700">POST /api/chat</h4>
                <pre class="bg-gray-100 p-3 rounded text-sm mt-2"><code>{
  "prompt": "Your question here",
  "preference": "cost" // or "performance"
}</code></pre>
            </div>
            <div>
                <h4 class="font-semibold text-gray-700">Headers</h4>
                <pre class="bg-gray-100 p-3 rounded text-sm mt-2"><code>X-API-Key: your_api_key_here
Content-Type: application/json</code></pre>
            </div>
        </div>
    </div>
</div>

<script>
function testInterface() {
    return {
        apiKey: 'demo_a665a45920422f9d',
        preference: 'cost',
        currentMessage: '',
        loading: false,
        chatHistory: [],
        lastResponse: null,
        
        async sendMessage() {
            if (!this.currentMessage.trim() || this.loading) return;
            
            const userMessage = {
                id: Date.now(),
                sender: 'You',
                content: this.currentMessage,
                timestamp: new Date().toLocaleTimeString()
            };
            
            this.chatHistory.push(userMessage);
            const prompt = this.currentMessage;
            this.currentMessage = '';
            this.loading = true;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': this.apiKey
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        preference: this.preference
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.chatHistory.push({
                        id: Date.now() + 1,
                        sender: data.model_used,
                        content: data.response,
                        timestamp: new Date().toLocaleTimeString(),
                        metadata: `${data.tokens_used} tokens • $${data.cost} • ${data.remaining_quota} remaining`
                    });
                    this.lastResponse = data;
                } else {
                    this.chatHistory.push({
                        id: Date.now() + 1,
                        sender: 'Error',
                        content: data.error || 'Unknown error occurred',
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            } catch (error) {
                this.chatHistory.push({
                    id: Date.now() + 1,
                    sender: 'Error',
                    content: 'Network error: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            } finally {
                this.loading = false;
                // Scroll to bottom
                setTimeout(() => {
                    const chatHistory = document.getElementById('chatHistory');
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }, 100);
            }
        }
    }
}
</script>
{% endblock %}