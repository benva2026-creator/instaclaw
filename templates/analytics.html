{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}
{% block header_title %}Analytics Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Requests -->
        <div class="bg-spotify-dark rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-spotify-green bg-opacity-20 rounded-xl">
                    <i class="fas fa-rocket text-spotify-green text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-spotify-text">
                        {% set total_requests = daily_stats|sum(attribute=1) if daily_stats else 0 %}
                        {{ "{:,}".format(total_requests) }}
                    </div>
                    <div class="text-spotify-text-gray text-sm">Total Requests</div>
                </div>
            </div>
            <div class="text-spotify-text-gray text-sm">Last 30 days</div>
            <div class="text-spotify-green text-sm mt-1">
                <i class="fas fa-arrow-up mr-1"></i>
                +12% from previous period
            </div>
        </div>

        <!-- Total Tokens -->
        <div class="bg-spotify-dark rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-blue-500 bg-opacity-20 rounded-xl">
                    <i class="fas fa-coins text-blue-400 text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-spotify-text">
                        {% set total_tokens = daily_stats|sum(attribute=2) if daily_stats else 0 %}
                        {{ "{:,}".format(total_tokens) }}
                    </div>
                    <div class="text-spotify-text-gray text-sm">Total Tokens</div>
                </div>
            </div>
            <div class="text-spotify-text-gray text-sm">Processed</div>
            <div class="text-blue-400 text-sm mt-1">
                <i class="fas fa-arrow-up mr-1"></i>
                +8% efficiency gain
            </div>
        </div>

        <!-- Total Cost -->
        <div class="bg-spotify-dark rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-yellow-500 bg-opacity-20 rounded-xl">
                    <i class="fas fa-dollar-sign text-yellow-400 text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-spotify-text">
                        {% set total_cost = daily_stats|sum(attribute=3) if daily_stats else 0 %}
                        ${{ "%.2f"|format(total_cost) }}
                    </div>
                    <div class="text-spotify-text-gray text-sm">Total Cost</div>
                </div>
            </div>
            <div class="text-spotify-text-gray text-sm">API spending</div>
            <div class="text-green-400 text-sm mt-1">
                <i class="fas fa-arrow-down mr-1"></i>
                -5% cost optimization
            </div>
        </div>

        <!-- Avg Response Time -->
        <div class="bg-spotify-dark rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-purple-500 bg-opacity-20 rounded-xl">
                    <i class="fas fa-stopwatch text-purple-400 text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-spotify-text">
                        {% if daily_stats %}
                            {% set avg_response = daily_stats|sum(attribute=4) / daily_stats|length %}
                            {{ "%.2f"|format(avg_response) }}s
                        {% else %}
                            0.85s
                        {% endif %}
                    </div>
                    <div class="text-spotify-text-gray text-sm">Avg Response</div>
                </div>
            </div>
            <div class="text-spotify-text-gray text-sm">Response time</div>
            <div class="text-green-400 text-sm mt-1">
                <i class="fas fa-arrow-down mr-1"></i>
                -15% faster
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Usage Over Time -->
        <div class="bg-spotify-dark rounded-2xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-spotify-text">Usage Over Time</h3>
                <div class="flex space-x-2">
                    <button onclick="updateChart('requests')" class="px-3 py-1 bg-spotify-green text-white rounded-lg text-sm" id="requestsBtn">
                        Requests
                    </button>
                    <button onclick="updateChart('tokens')" class="px-3 py-1 bg-spotify-gray hover:bg-spotify-light-gray text-spotify-text rounded-lg text-sm" id="tokensBtn">
                        Tokens
                    </button>
                    <button onclick="updateChart('cost')" class="px-3 py-1 bg-spotify-gray hover:bg-spotify-light-gray text-spotify-text rounded-lg text-sm" id="costBtn">
                        Cost
                    </button>
                </div>
            </div>
            <div class="h-64">
                <canvas id="usageChart"></canvas>
            </div>
        </div>

        <!-- Model Usage Distribution -->
        <div class="bg-spotify-dark rounded-2xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-spotify-text">Model Usage</h3>
                <div class="text-sm text-spotify-text-gray">Last 30 days</div>
            </div>
            <div class="h-64">
                <canvas id="modelChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Top Models -->
        <div class="bg-spotify-dark rounded-2xl p-6">
            <h3 class="text-xl font-semibold text-spotify-text mb-4">Top Models</h3>
            <div class="space-y-4">
                {% if model_stats %}
                    {% for model, requests, tokens, cost in model_stats %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 rounded-full bg-spotify-green"></div>
                            <div>
                                <div class="text-spotify-text font-medium">{{ model }}</div>
                                <div class="text-spotify-text-gray text-sm">{{ "{:,}".format(tokens) }} tokens</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-spotify-text font-medium">{{ requests }}</div>
                            <div class="text-spotify-text-gray text-sm">${{ "%.2f"|format(cost) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar text-2xl text-spotify-text-gray mb-2"></i>
                        <p class="text-spotify-text-gray">No model data available</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-spotify-dark rounded-2xl p-6">
            <h3 class="text-xl font-semibold text-spotify-text mb-4">Performance</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-tachometer-alt text-spotify-green"></i>
                        <div>
                            <div class="text-spotify-text font-medium">Success Rate</div>
                            <div class="text-spotify-text-gray text-sm">API responses</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-spotify-green font-bold">99.8%</div>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-clock text-blue-400"></i>
                        <div>
                            <div class="text-spotify-text font-medium">P95 Latency</div>
                            <div class="text-spotify-text-gray text-sm">95th percentile</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-blue-400 font-bold">1.2s</div>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        <div>
                            <div class="text-spotify-text font-medium">Error Rate</div>
                            <div class="text-spotify-text-gray text-sm">Failed requests</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-yellow-400 font-bold">0.2%</div>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-shield-alt text-purple-400"></i>
                        <div>
                            <div class="text-spotify-text font-medium">Uptime</div>
                            <div class="text-spotify-text-gray text-sm">Service availability</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-purple-400 font-bold">99.99%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Breakdown -->
        <div class="bg-spotify-dark rounded-2xl p-6">
            <h3 class="text-xl font-semibold text-spotify-text mb-4">Cost Analysis</h3>
            <div class="space-y-4">
                <div class="bg-spotify-gray rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-spotify-text-gray text-sm">This Month</span>
                        <span class="text-spotify-green font-bold">
                            ${{ "%.2f"|format(daily_stats|sum(attribute=3) if daily_stats else 12.45) }}
                        </span>
                    </div>
                    <div class="text-xs text-spotify-text-gray">
                        {% if daily_stats %}
                            {{ "{:,}".format(daily_stats|sum(attribute=2)) }} tokens processed
                        {% else %}
                            15,230 tokens processed
                        {% endif %}
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-spotify-text-gray text-sm">OpenAI GPT-4</span>
                        <span class="text-spotify-text">$8.50</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-spotify-text-gray text-sm">GPT-3.5 Turbo</span>
                        <span class="text-spotify-text">$2.15</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-spotify-text-gray text-sm">Claude Sonnet</span>
                        <span class="text-spotify-text">$1.80</span>
                    </div>
                </div>

                <div class="pt-3 border-t border-spotify-light-gray">
                    <div class="text-center">
                        <button onclick="exportCostReport()" class="text-spotify-green hover:text-spotify-green-hover text-sm">
                            <i class="fas fa-download mr-1"></i>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-spotify-dark rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-spotify-text">Recent Activity</h3>
            <button onclick="refreshActivity()" class="text-spotify-green hover:text-spotify-green-hover">
                <i class="fas fa-refresh mr-1"></i>Refresh
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-spotify-text-gray text-sm">
                        <th class="pb-3">Timestamp</th>
                        <th class="pb-3">Model</th>
                        <th class="pb-3">Tokens</th>
                        <th class="pb-3">Cost</th>
                        <th class="pb-3">Response Time</th>
                        <th class="pb-3">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_usage %}
                        {% for model, tokens, cost, timestamp, response_time in recent_usage %}
                        <tr class="text-spotify-text hover:bg-spotify-gray transition-colors duration-200">
                            <td class="py-3">{{ timestamp.split('T')[0] }}</td>
                            <td class="py-3">
                                <span class="px-2 py-1 bg-spotify-green bg-opacity-20 text-spotify-green rounded text-xs">
                                    {{ model }}
                                </span>
                            </td>
                            <td class="py-3">{{ "{:,}".format(tokens) }}</td>
                            <td class="py-3">${{ "%.4f"|format(cost) }}</td>
                            <td class="py-3">{{ "%.2f"|format(response_time) }}s</td>
                            <td class="py-3">
                                <span class="px-2 py-1 bg-spotify-green bg-opacity-20 text-spotify-green rounded text-xs">
                                    <i class="fas fa-check mr-1"></i>Success
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="py-8 text-center text-spotify-text-gray">
                                <i class="fas fa-history text-2xl mb-2"></i>
                                <div>No recent activity</div>
                                <div class="text-sm mt-1">Start making API calls to see usage data</div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if recent_usage and recent_usage|length >= 50 %}
        <div class="mt-6 text-center">
            <button onclick="loadMoreActivity()" class="bg-spotify-gray hover:bg-spotify-light-gray text-spotify-text px-6 py-2 rounded-lg transition-colors duration-200">
                Load More
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Chart.js configuration
    Chart.defaults.color = '#b3b3b3';
    Chart.defaults.borderColor = '#3e3e3e';

    // Usage over time chart
    const usageCtx = document.getElementById('usageChart').getContext('2d');
    const usageChart = new Chart(usageCtx, {
        type: 'line',
        data: {
            labels: [
                {% if daily_stats %}
                    {% for date, requests, tokens, cost, response_time in daily_stats %}
                        '{{ date.split('-')[1] }}/{{ date.split('-')[2] }}',
                    {% endfor %}
                {% else %}
                    {% for i in range(30) %}
                        '{{ (i + 1) }}',
                    {% endfor %}
                {% endif %}
            ],
            datasets: [{
                label: 'Requests',
                data: [
                    {% if daily_stats %}
                        {% for date, requests, tokens, cost, response_time in daily_stats %}
                            {{ requests }},
                        {% endfor %}
                    {% else %}
                        // Mock data for demo
                        12, 15, 18, 22, 25, 19, 23, 28, 32, 29, 35, 38, 42, 39, 45, 48, 52, 49, 55, 58, 62, 59, 65, 68, 72, 69, 75, 78, 82, 79
                    {% endif %}
                ],
                borderColor: '#1db954',
                backgroundColor: 'rgba(29, 185, 84, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#3e3e3e'
                    }
                },
                x: {
                    grid: {
                        color: '#3e3e3e'
                    }
                }
            }
        }
    });

    // Model usage pie chart
    const modelCtx = document.getElementById('modelChart').getContext('2d');
    const modelChart = new Chart(modelCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% if model_stats %}
                    {% for model, requests, tokens, cost in model_stats %}
                        '{{ model }}',
                    {% endfor %}
                {% else %}
                    'GPT-3.5 Turbo', 'GPT-4', 'Claude Sonnet', 'Claude Haiku'
                {% endif %}
            ],
            datasets: [{
                data: [
                    {% if model_stats %}
                        {% for model, requests, tokens, cost in model_stats %}
                            {{ requests }},
                        {% endfor %}
                    {% else %}
                        45, 30, 15, 10
                    {% endif %}
                ],
                backgroundColor: [
                    '#1db954',
                    '#1ed760',
                    '#4ade80',
                    '#86efac'
                ],
                borderColor: '#121212',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    function updateChart(metric) {
        // Update button states
        document.querySelectorAll('[id$="Btn"]').forEach(btn => {
            btn.className = 'px-3 py-1 bg-spotify-gray hover:bg-spotify-light-gray text-spotify-text rounded-lg text-sm';
        });
        document.getElementById(metric + 'Btn').className = 'px-3 py-1 bg-spotify-green text-white rounded-lg text-sm';

        // Update chart data based on metric
        let newData, label, color;
        
        if (metric === 'requests') {
            newData = [
                {% if daily_stats %}
                    {% for date, requests, tokens, cost, response_time in daily_stats %}
                        {{ requests }},
                    {% endfor %}
                {% else %}
                    12, 15, 18, 22, 25, 19, 23, 28, 32, 29, 35, 38, 42, 39, 45, 48, 52, 49, 55, 58, 62, 59, 65, 68, 72, 69, 75, 78, 82, 79
                {% endif %}
            ];
            label = 'Requests';
            color = '#1db954';
        } else if (metric === 'tokens') {
            newData = [
                {% if daily_stats %}
                    {% for date, requests, tokens, cost, response_time in daily_stats %}
                        {{ tokens }},
                    {% endfor %}
                {% else %}
                    1200, 1500, 1800, 2200, 2500, 1900, 2300, 2800, 3200, 2900, 3500, 3800, 4200, 3900, 4500, 4800, 5200, 4900, 5500, 5800, 6200, 5900, 6500, 6800, 7200, 6900, 7500, 7800, 8200, 7900
                {% endif %}
            ];
            label = 'Tokens';
            color = '#3b82f6';
        } else if (metric === 'cost') {
            newData = [
                {% if daily_stats %}
                    {% for date, requests, tokens, cost, response_time in daily_stats %}
                        {{ cost }},
                    {% endfor %}
                {% else %}
                    0.12, 0.15, 0.18, 0.22, 0.25, 0.19, 0.23, 0.28, 0.32, 0.29, 0.35, 0.38, 0.42, 0.39, 0.45, 0.48, 0.52, 0.49, 0.55, 0.58, 0.62, 0.59, 0.65, 0.68, 0.72, 0.69, 0.75, 0.78, 0.82, 0.79
                {% endif %}
            ];
            label = 'Cost ($)';
            color = '#eab308';
        }

        usageChart.data.datasets[0].data = newData;
        usageChart.data.datasets[0].label = label;
        usageChart.data.datasets[0].borderColor = color;
        usageChart.data.datasets[0].backgroundColor = color + '20';
        usageChart.update();
    }

    function exportCostReport() {
        // Create CSV data
        const csvData = [
            ['Date', 'Model', 'Requests', 'Tokens', 'Cost'],
            {% if recent_usage %}
                {% for model, tokens, cost, timestamp, response_time in recent_usage %}
                    ['{{ timestamp.split('T')[0] }}', '{{ model }}', '1', '{{ tokens }}', '{{ cost }}'],
                {% endfor %}
            {% endif %}
        ];

        const csvContent = csvData.map(row => row.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'llm-gateway-usage-report.csv';
        link.click();
        window.URL.revokeObjectURL(url);
        
        showNotification('Usage report exported successfully!');
    }

    function refreshActivity() {
        showNotification('Refreshing activity data...');
        // In a real app, this would reload the data
        setTimeout(() => {
            showNotification('Activity data refreshed!');
        }, 1000);
    }

    function loadMoreActivity() {
        showNotification('Loading more activity...');
        // In a real app, this would load more rows
    }
</script>
{% endblock %}